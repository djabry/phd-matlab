function [ fPath ] = downloadProfileData( lims,hres )
%lims includes limits for profile

if ~exist('lims','var') || isempty(lims)
    %Limits are in order: lat, lon, pressure, time
    lims = [-180,180;-90,90;0,1000;0,now];
end

if ~exist('hres','var')||isempty(hres)
    %Grid spacing in degrees [lon lat]
    hres = [0.75,0.75];
    
end

javaaddpath('../ext/java/JSON.jar');
javaaddpath('../ext/java/ECMWF-API.jar');
javaaddpath('../ext/java/netcdfAll-4.3.jar');


import org.ecmwf.*;
import org.json.*;
import ucar.grib.*;


levLst = generateLevList();


server = DataServer();
request = JSONObject();
target = 'output.grib';


request.put('dataset'   , 'interim');
request.put('levelist',generateLevString(lims));
request.put('levtype','pl');

%Include temperature, RH and ozone
request.put('param','130.128/157.128/203.128');
request.put('step','0');
request.put('grid',generateGridString(hres));
request.put('time','00/06/12/18');


request.put('area',generateAreaString(lims));


request.put('date',generateDateString(lims));
request.put('class','ei');
request.put('target',target);


if ~exist(target,'file')
    server.retrieve(request);
end

clear server request;
args = javaArray ('java.lang.String', 2);
args(1) =java.lang.String(target);
args(2) =java.lang.String('output.nc');
ucar.grib.Grib2Netcdf.main(args);


fPath = [pwd,target];


    function fPref = generateFileName(lims,hres)
        
        dta = [lims;hres];
        
        
        
        
    end


    function dateString = generateDateString(lims)
        
        formatOut = 'yyyy-mm-dd';
        dateString = [datestr(lims(4,1),formatOut),'/to/',datestr(lims(4,2),formatOut)]; 
        
        
    end


    function gridString = generateGridString(hres)
        
        gridString = [num2str(hres(1)),'/',num2str(hres(2))];
        
    end


    function areaString = generateAreaString(lims)
        lats = lims(2,:);
        lons = lims(1,:);
        
        %Area specified in [North,West,South,East] format
        
        areaString=[num2str(lats(2)),'/',num2str(lons(1)),'/',num2str(lats(1)),'/',num2str(lons(2))];
    end


    function levString = generateLevString(lims)
        
        levString = '';
        levLims = lims(3,:);
        
        for i =1:length(levLst)
            
            levVal = levLst(i);
            
            if(levVal>=min(levLims) && levVal<=max(levLims))

                startChar = '/';
                
                if strcmp(levString,'')
                    
                    startChar = '';
                end
                
                
                levString = [levString,startChar,num2str(levVal)];
                
            end
        end
        
    end


    function levLst = generateLevList()
        
        levLst = zeros(1,37);
        
        ix = 1;
        
        for i = 1000:-25:750
            levLst(ix)=i;
            ix = ix+1;
            
        end
        
        for i = 700:-50:250
            levLst(ix)=i;
            ix= ix+1;
        end
        
        for i = 225:-25:100
            levLst(ix)=i;
            ix = ix+1;
        end
        
        levLst(ix:end)=[70 50 30 20 10 7 5 3 2 1];
        
        
    end


end

